# This workflow runs the NH agent benchmarks.
name: Benchmark

on:
  workflow_dispatch:

jobs:
  run-overhead-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/checkout@v3
      with:
        ref: benchmark-results
        path: benchmark-results
    - name: copy results from benchmark-results branch
      run: |
        rsync -avv benchmark-results/benchmark/results/ benchmark/results/
    - name: run tests
      uses: gradle/gradle-build-action@v2
      with:
        arguments: test
        build-root-directory: benchmark
      env:
        # These two secrets `secrets.GP_USERNAME` and `secrets.GP_TOKEN` are Github's PAT (Personal Access Token),
        # which are used to download private packages from Github Packages (in our case, the Joboe core libs from https://github.com/librato/joboe)
        # Gradle fetches the dependencies from Github Packages with this user/token pair, see build.gradle for the repositories config.
        #
        # Currently the PAT is set up under the trace-build service account and just requires read:packages access to the Librato org.
        # (Check out this document about how to create a PAT: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)
        GP_USERNAME: ${{ secrets.GP_USERNAME }}
        GP_TOKEN: ${{ secrets.GP_TOKEN }}
        SOLARWINDS_SERVICE_KEY: ${{ secrets.SOLARWINDS_SERVICE_KEY }}
    - name: inspect the results dir
      if: always()
      working-directory: benchmark
      run: ls -lR results
    - name: copy results back to gh-pages branch
      if: always()
      run: |
        rsync -avv benchmark/results/ benchmark-results/benchmark/results/ && rm -rf benchmark/results
        rsync -avv benchmark/build/reports/tests/test/index.html benchmark-results/benchmark/results/  && rm -rf benchmark/build/reports/tests/test/index.html
    - name: commit updated results
      if: always()
      uses: EndBug/add-and-commit@v9
      with:
        add: 'benchmark/results'
        cwd: './benchmark-results'
        branch: 'benchmark-results'
        message: 'update test result data'
        author_name: trace-build
        committer_name: trace-build

